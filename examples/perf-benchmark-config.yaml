# EvalScope Perfæ€§èƒ½åŸºå‡†æµ‹è¯•ä¸“ç”¨é…ç½®
# ä¸“ä¸ºLinux perfå·¥å…·æ€§èƒ½åˆ†æä¼˜åŒ–

evalscope:
  # ======================== æ¨¡å‹é…ç½® ========================
  models:
    # æ¨¡å‹1: è½»é‡çº§Mockæ¨¡å‹ (CPUæ€§èƒ½æµ‹è¯•)
    perf-mock-cpu:
      type: "chat"
      provider: "mock"
      enabled: true
      parameters:
        endpoint: "mock://localhost:8080"
        max_tokens: 256
        temperature: 0.1
        response_delay_ms: 10      # æå°å»¶è¿Ÿï¼Œä¸“æ³¨CPUæ€§èƒ½
        response_variation_ms: 5
        success_rate: 0.99
        simulate_cpu_load: true    # æ¨¡æ‹ŸCPUè´Ÿè½½
        cpu_intensive_operations: 1000  # CPUå¯†é›†å‹æ“ä½œæ¬¡æ•°
      credentials:
        mock_auth: "perf-cpu"

    # æ¨¡å‹2: å†…å­˜åˆ†é…æµ‹è¯•æ¨¡å‹
    perf-mock-memory:
      type: "chat"
      provider: "mock"
      enabled: true
      parameters:
        endpoint: "mock://localhost:8081"
        max_tokens: 2048           # å¤§tokenæµ‹è¯•å†…å­˜åˆ†é…
        temperature: 0.1
        response_delay_ms: 50
        response_variation_ms: 20
        success_rate: 0.98
        simulate_memory_allocation: true  # æ¨¡æ‹Ÿå†…å­˜åˆ†é…
        memory_allocation_mb: 50   # æ¯æ¬¡åˆ†é…50MB
        gc_pressure: true          # äº§ç”ŸGCå‹åŠ›
      credentials:
        mock_auth: "perf-memory"

    # æ¨¡å‹3: I/Oæ€§èƒ½æµ‹è¯•æ¨¡å‹
    perf-mock-io:
      type: "chat"
      provider: "mock"
      enabled: true
      parameters:
        endpoint: "mock://localhost:8082"
        max_tokens: 512
        temperature: 0.1
        response_delay_ms: 200     # I/Oç­‰å¾…æ¨¡æ‹Ÿ
        response_variation_ms: 100
        success_rate: 0.95
        simulate_io_wait: true     # æ¨¡æ‹ŸI/Oç­‰å¾…
        io_operations_per_request: 50
      credentials:
        mock_auth: "perf-io"

    # æ¨¡å‹4: å¹¶å‘æ€§èƒ½æµ‹è¯•æ¨¡å‹
    perf-mock-concurrent:
      type: "chat"
      provider: "mock"
      enabled: true
      parameters:
        endpoint: "mock://localhost:8083"
        max_tokens: 1024
        temperature: 0.1
        response_delay_ms: 100
        response_variation_ms: 50
        success_rate: 0.99
        thread_contention: true    # æ¨¡æ‹Ÿçº¿ç¨‹ç«äº‰
        lock_contention_probability: 0.1  # 10%é”ç«äº‰
      credentials:
        mock_auth: "perf-concurrent"

  # ======================== Perfä¸“ç”¨æ€§èƒ½è¯„ä¼° ========================
  evaluations:
    # CPUæ€§èƒ½åŸºå‡†æµ‹è¯• (perfåˆ†æä¸“ç”¨)
    perf_cpu_analysis:
      models: ["perf-mock-cpu"]
      evaluators: ["chat"]
      maxConcurrency: 10
      saveResults: true
      outputPath: "perf-results/cpu-analysis"
      parameters:
        max_examples: 100
        timeout_seconds: 30
        warmup_iterations: 10
        test_iterations: 500
        concurrent_levels: [1, 5, 10]      # ä¸åŒå¹¶å‘çº§åˆ«
        benchmark_focus: "cpu_cycles"      # ä¸“æ³¨CPUå‘¨æœŸ
        cpu_intensive_ratio: 0.8            # 80%CPUå¯†é›†å‹æ“ä½œ
        perf_events: "cpu-clock,cache-misses,instructions"  # perfäº‹ä»¶

    # å†…å­˜æ€§èƒ½åŸºå‡†æµ‹è¯•
    perf_memory_analysis:
      models: ["perf-mock-memory"]
      evaluators: ["chat"]
      maxConcurrency: 5
      saveResults: true
      outputPath: "perf-results/memory-analysis"
      parameters:
        max_examples: 50
        timeout_seconds: 60
        warmup_iterations: 5
        test_iterations: 200
        concurrent_levels: [1, 3, 5]
        benchmark_focus: "memory_allocation"
        memory_pressure_mb: 1000            # 1000MBå†…å­˜å‹åŠ›
        allocation_frequency: "high"        # é«˜é¢‘åˆ†é…
        perf_events: "cache-misses,page-faults,minor-faults,major-faults"

    # I/Oæ€§èƒ½åŸºå‡†æµ‹è¯•
    perf_io_analysis:
      models: ["perf-mock-io"]
      evaluators: ["chat"]
      maxConcurrency: 15
      saveResults: true
      outputPath: "perf-results/io-analysis"
      parameters:
        max_examples: 80
        timeout_seconds: 45
        warmup_iterations: 8
        test_iterations: 300
        concurrent_levels: [5, 10, 15]
        benchmark_focus: "io_latency"
        io_wait_simulation: true
        disk_io_simulation: false           # ä¸“æ³¨ç½‘ç»œI/O
        perf_events: "block:block_rq_issue,block:block_rq_complete"

    # å¹¶å‘ç«äº‰åˆ†æ
    perf_contention_analysis:
      models: ["perf-mock-concurrent"]
      evaluators: ["chat"]
      maxConcurrency: 20
      saveResults: true
      outputPath: "perf-results/contention-analysis"
      parameters:
        max_examples: 120
        timeout_seconds: 25
        warmup_iterations: 15
        test_iterations: 400
        concurrent_levels: [10, 15, 20]
        benchmark_focus: "lock_contention"
        thread_contention_simulation: true
        lock_analysis: true                 # é”ç«äº‰åˆ†æ
        perf_events: "sched:sched_switch,lock:lock_acquire"

    # ç»¼åˆæ€§èƒ½å‹åŠ›æµ‹è¯• (perfç»¼åˆ)
    perf_stress:
      models: ["perf-mock-cpu", "perf-mock-memory", "perf-mock-io", "perf-mock-concurrent"]
      evaluators: ["chat"]
      maxConcurrency: 50
      saveResults: true
      outputPath: "perf-results/comprehensive-stress"
      parameters:
        max_examples: 200
        timeout_seconds: 120
        warmup_iterations: 20
        test_iterations: 1000
        concurrent_levels: [10, 25, 50]
        load_pattern: "step_ramp"           # é˜¶æ¢¯å¼å¢å‹
        duration_minutes: 30
        mixed_workload: true                # æ··åˆå·¥ä½œè´Ÿè½½
        cpu_memory_ratio: "60:40"           # CPU:å†…å­˜ = 60:40
        perf_events: "cpu-clock,task-clock,page-faults,cache-misses"
        flame_graph_enabled: true           # å¯ç”¨ç«ç„°å›¾

    # JVMæ€§èƒ½ä¸“é¡¹æµ‹è¯•
    perf_jvm_analysis:
      models: ["perf-mock-cpu"]
      evaluators: ["chat"]
      maxConcurrency: 8
      saveResults: true
      outputPath: "perf-results/jvm-analysis"
      parameters:
        max_examples: 150
        timeout_seconds: 40
        warmup_iterations: 12
        test_iterations: 600
        concurrent_levels: [2, 4, 8]
        benchmark_focus: "jvm_internal"
        gc_analysis: true                   # GCåˆ†æ
        jit_analysis: true                  # JITåˆ†æ
        heap_profiling: true               # å †åˆ†æ
        jvm_flags: "-XX:+UnlockDiagnosticVMOptions -XX:+DebugNonSafepoints"
        perf_events: "cpu-clock,instructions,cache-misses,branches"

  # ======================== Perfä¸“ç”¨ç›‘æ§è®¾ç½® ========================
  settings:
    # åŸºç¡€æ€§èƒ½è®¾ç½®
    max_job_concurrency: 20
    response_timeout_seconds: 120
    result_format: "json"
    log_level: "INFO"
    debug_memory_info: true              # è°ƒè¯•å†…å­˜ä¿¡æ¯

    # perfé›†æˆé…ç½®
    perf_integration:
      enabled: true
      perf_events_preset: "cpu,memory,cache"  # é¢„è®¾äº‹ä»¶ç»„
      sampling_frequency: 99                  # é‡‡æ ·é¢‘ç‡(Hz)
      call_graph_collection: true             # æ”¶é›†è°ƒç”¨å›¾
      user_space_only: false                  # åŒ…å«å†…æ ¸ç©ºé—´

      # æ€§èƒ½äº‹ä»¶è¯¦ç»†é…ç½®
      performance_events:
        cpu_events:
          - "cpu-clock"           # CPUæ—¶é’Ÿå‘¨æœŸ
          - "task-clock"          # ä»»åŠ¡æ—¶é’Ÿ
          - "instructions"        # æŒ‡ä»¤æ•°
          - "branches"            # åˆ†æ”¯æŒ‡ä»¤
          - "branch-misses"       # åˆ†æ”¯é¢„æµ‹å¤±è´¥
        memory_events:
          - "cache-misses"        # ç¼“å­˜æœªå‘½ä¸­
          - "cache-references"    # ç¼“å­˜å¼•ç”¨
          - "L1-dcache-loads"     # L1æ•°æ®ç¼“å­˜åŠ è½½
          - "LLC-loads"           # æœ€åä¸€çº§ç¼“å­˜åŠ è½½
          - "page-faults"         # é¡µé¢é”™è¯¯
        system_events:
          - "context-switches"    # ä¸Šä¸‹æ–‡åˆ‡æ¢
          - "cpu-migrations"      # CPUè¿ç§»
          - "minor-faults"        # è½»å¾®é¡µé¢é”™è¯¯
          - "major-faults"        # ä¸¥é‡é¡µé¢é”™è¯¯

      # è°ƒç”¨æ ˆå’Œç«ç„°å›¾è®¾ç½®
      call_graph_config:
        fp_mode: true              # å¸§æŒ‡é’ˆæ¨¡å¼(æ›´ç²¾ç¡®)
        dwarf_mode: false          # DWARFæ¨¡å¼(å¤‡é€‰)
        max_stack_depth: 127       # æœ€å¤§æ ˆæ·±åº¦
        flame_graph_enabled: true  # å¯ç”¨ç«ç„°å›¾

      # ç³»ç»Ÿçº§ç›‘æ§
      system_monitoring:
        cpu_utilization: true     # CPUä½¿ç”¨ç‡
        memory_usage: true        # å†…å­˜ä½¿ç”¨
        io_statistics: true       # I/Oç»Ÿè®¡
        network_stats: true       # ç½‘ç»œç»Ÿè®¡

      # è¿›ç¨‹çº§ç›‘æ§
      process_monitoring:
        thread_stats: true        # çº¿ç¨‹ç»Ÿè®¡
        file_descriptors: true   # æ–‡ä»¶æè¿°ç¬¦
        memory_maps: true        # å†…å­˜æ˜ å°„
        perf_stat_interval: 1    # perf staté‡‡æ ·é—´éš”(ç§’)

    # JVMæ€§èƒ½è°ƒä¼˜å»ºè®®
    jvm_optimization:
      heap_sizing: "adaptive"     # è‡ªé€‚åº”å †å¤§å°
      gc_tuning: "throughput"     # ååé‡ä¼˜å…ˆGC
      compiler_optimization: true # ç¼–è¯‘ä¼˜åŒ–
      profile_guided: false       # å¼•å¯¼ä¼˜åŒ–

      # æ¨èJVMå‚æ•°
      recommended_flags:
        - "-XX:+UseG1GC"                    # G1åƒåœ¾æ”¶é›†å™¨
        - "-XX:MaxGCPauseMillis=200"       # GCæš‚åœæ—¶é—´ç›®æ ‡
        - "-XX:+UnlockDiagnosticVMOptions"  # è¯Šæ–­é€‰é¡¹
        - "-XX:+DebugNonSafepoints"         # è°ƒè¯•éå®‰å…¨ç‚¹
        - "-XX:+PreserveFramePointer"       # ä¿ç•™å¸§æŒ‡é’ˆ(perfå…¼å®¹æ€§)
        - "-XX:-TieredCompilation"          # ç¦ç”¨åˆ†å±‚ç¼–è¯‘(æµ‹è¯•æ—¶)

    # æ€§èƒ½é˜ˆå€¼è®¾ç½®
    performance_thresholds:
      cpu_usage_percent: 80       # CPUä½¿ç”¨ç‡è­¦å‘Šé˜ˆå€¼
      memory_usage_mb: 4000       # å†…å­˜ä½¿ç”¨è­¦å‘Šé˜ˆå€¼
      response_time_ms: 5000      # å“åº”æ—¶é—´è­¦å‘Šé˜ˆå€¼
      error_rate_percent: 1.0     # é”™è¯¯ç‡è­¦å‘Šé˜ˆå€¼

    # ä¼ä¸šé›†æˆæ‰©å±•
    enterprise:
      prometheus_metrics_enabled: true
      grafana_dashboards: true
      alerting:
        slack_webhook: "${SLACK_WEBHOOK_URL}"
        thresholds:
          cpu_cycles_per_instruction: 2.0    # CPIé˜ˆå€¼
          cache_miss_rate_percent: 5.0       # ç¼“å­˜æœªå‘½ä¸­ç‡é˜ˆå€¼
          memory_bandwidth_utilization: 80  # å†…å­˜å¸¦å®½åˆ©ç”¨ç‡é˜ˆå€¼

## ğŸ”§ ä½¿ç”¨è¯´æ˜

### åŸºæœ¬perfæ€§èƒ½åˆ†æ
```bash
# è¿è¡ŒCPUæ€§èƒ½åˆ†æ
sudo perf stat -e cpu-clock,instructions,cache-misses \
  java -jar target/evalscope-*.jar --config examples/perf-benchmark-config.yaml

# è¿è¡Œå®Œæ•´çš„perfæµ‹è¯•è„šæœ¬
./examples/perf-benchmark.sh
```

### ç«ç„°å›¾ç”Ÿæˆ
```bash
# å®‰è£…FlameGraphå·¥å…·
git clone https://github.com/brendangregg/FlameGraph.git

# ç”Ÿæˆç«ç„°å›¾
perf script -i perf-results/cpu-analysis/perf_*.data | \
  ~/FlameGraph/stackcollapse-perf.pl | \
  ~/FlameGraph/flamegraph.pl > flamegraph.svg
```

### æ€§èƒ½åˆ†æè¦ç‚¹
1. **CPUå‘¨æœŸ(CPI)**: æ¯æ¡æŒ‡ä»¤éœ€è¦çš„CPUå‘¨æœŸæ•°
2. **ç¼“å­˜å‘½ä¸­ç‡**: L1/L2/LLCç¼“å­˜å‘½ä¸­æƒ…å†µ
3. **åˆ†æ”¯é¢„æµ‹å¤±è´¥ç‡**: åˆ†æ”¯é¢„æµ‹å‡†ç¡®æ€§
4. **å†…å­˜å¸¦å®½åˆ©ç”¨ç‡**: å†…å­˜å­ç³»ç»Ÿæ•ˆç‡
5. **é”ç«äº‰**: çº¿ç¨‹åŒæ­¥å¼€é”€

### ç³»ç»Ÿçº§æ€§èƒ½è°ƒä¼˜
```bash
# CPUè°ƒä¼˜
echo performance > /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor

# å†…å­˜è°ƒä¼˜
echo 1 > /proc/sys/vm/drop_caches  # æ¸…é™¤ç¼“å­˜

# Perfæƒé™è®¾ç½®
echo -1 > /proc/sys/kernel/perf_event_paranoid
```

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡è§£è¯»

### CPUæ€§èƒ½æŒ‡æ ‡
- **CPI (Cycles Per Instruction)**: < 1.0 ä¼˜ç§€, > 2.0 éœ€è¦ä¼˜åŒ–
- **Cache Miss Rate**: < 5% è‰¯å¥½, > 10% éœ€è¦å…³æ³¨
- **Branch Prediction**: > 90% è‰¯å¥½, < 80% éœ€è¦ä¼˜åŒ–

### å†…å­˜æ€§èƒ½æŒ‡æ ‡
- **Page Fault Rate**: è¶Šä½è¶Šå¥½
- **Memory Bandwidth**: åˆ©ç”¨ç‡ < 80%
- **TLB Miss Rate**: è¶Šä½è¶Šå¥½

### å¹¶å‘æ€§èƒ½æŒ‡æ ‡
- **Lock Contention**: é”ç­‰å¾…æ—¶é—´ < 5%
- **Context Switch Rate**: é¿å…è¿‡åº¦ä¸Šä¸‹æ–‡åˆ‡æ¢
- **CPU Migration**: å‡å°‘è·¨CPUè¿ç§»

è¿™å¥—é…ç½®ä¸ºç”Ÿäº§ç¯å¢ƒçš„AIæœåŠ¡æä¾›äº†ç³»ç»Ÿçº§çš„æ€§èƒ½åˆ†ææ¡†æ¶ï¼ğŸ”¥